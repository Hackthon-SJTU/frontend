<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReasoningACTION - AIè§†é¢‘ç”Ÿæˆç³»ç»Ÿ</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }
        
        /* åŠ¨ç”» */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        .animate-pulse {
            animation: pulse 2s infinite;
        }
        
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        
        /* ç»ç’ƒæ€æ•ˆæœ */
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* å¯¹è¯æ°”æ³¡ */
        .message-user {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 18px 18px 4px 18px;
            padding: 12px 16px;
            max-width: 70%;
            word-wrap: break-word;
        }
        
        .message-assistant {
            background: white;
            color: #1f2937;
            border-radius: 18px 18px 18px 4px;
            padding: 12px 16px;
            max-width: 70%;
            word-wrap: break-word;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        /* è¿›åº¦æ¡ */
        .progress-bar {
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        /* å·¥ä½œæµæ­¥éª¤ */
        .workflow-step {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .workflow-step.active {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.3);
        }
        
        .workflow-step.completed {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .step-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 16px;
        }
        
        .step-icon.pending {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .step-icon.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .step-icon.completed {
            background: #10b981;
            color: white;
        }
        
        /* è§†é¢‘é¢„è§ˆ */
        .video-container {
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }
        
        /* æŒ‰é’® */
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: white;
            color: #667eea;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: 2px solid #667eea;
            cursor: pointer;
        }
        
        .btn-secondary:hover {
            background: rgba(99, 102, 241, 0.1);
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;
        
        // APIé…ç½®
        const API_BASE_URL = 'http://localhost:8000';
        
        // å·¥ä½œæµæ­¥éª¤å®šä¹‰
        const WORKFLOW_STEPS = [
            { id: 'extract', name: 'æç‚¼æ ¸å¿ƒæ¦‚å¿µ', icon: 'ğŸ¤–' },
            { id: 'generate_image', name: 'ç”Ÿæˆåˆå§‹å›¾ç‰‡', icon: 'ğŸ¨' },
            { id: 'generate_video', name: 'ç”Ÿæˆè§†é¢‘ç‰‡æ®µ', icon: 'ğŸ¬' },
            { id: 'generate_audio', name: 'ç”ŸæˆéŸ³é¢‘', icon: 'ğŸµ' },
            { id: 'merge', name: 'åˆæˆæœ€ç»ˆè§†é¢‘', icon: 'ğŸï¸' }
        ];
        
        // ä¸»åº”ç”¨ç»„ä»¶
        function App() {
            const [messages, setMessages] = useState([]);
            const [inputText, setInputText] = useState('');
            const [isProcessing, setIsProcessing] = useState(false);
            const [currentSession, setCurrentSession] = useState(null);
            const [workflowStatus, setWorkflowStatus] = useState({
                step: '',
                progress: 0,
                currentVideoSegment: 0
            });
            const [videoUrl, setVideoUrl] = useState(null);
            const [gptPrompt, setGptPrompt] = useState('');
            const messagesEndRef = useRef(null);
            const wsRef = useRef(null);
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            };
            
            useEffect(() => {
                scrollToBottom();
            }, [messages]);
            
            // WebSocketè¿æ¥
            const connectWebSocket = (sessionId) => {
                const ws = new WebSocket(`ws://localhost:8000/ws/${sessionId}`);
                
                ws.onopen = () => {
                    console.log('WebSocketè¿æ¥å·²å»ºç«‹');
                };
                
                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    if (data.type === 'progress') {
                        // è§£æè¿›åº¦ä¿¡æ¯
                        let currentVideoSegment = 0;
                        if (data.step.includes('è§†é¢‘ç‰‡æ®µ')) {
                            const match = data.step.match(/(\d+)\/10/);
                            if (match) {
                                currentVideoSegment = parseInt(match[1]);
                            }
                        }
                        
                        setWorkflowStatus({
                            step: data.step,
                            progress: data.progress,
                            currentVideoSegment
                        });
                    }
                };
                
                ws.onerror = (error) => {
                    console.error('WebSocketé”™è¯¯:', error);
                };
                
                ws.onclose = () => {
                    console.log('WebSocketè¿æ¥å·²å…³é—­');
                };
                
                wsRef.current = ws;
            };
            
            // å‘é€æ¶ˆæ¯
            const sendMessage = async () => {
                if (!inputText.trim()) return;
                
                const userMessage = inputText;
                setInputText('');
                setIsProcessing(true);
                
                // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
                setMessages(prev => [...prev, {
                    type: 'user',
                    content: userMessage,
                    timestamp: new Date()
                }]);
                
                try {
                    // è°ƒç”¨èŠå¤©API
                    const response = await fetch(`${API_BASE_URL}/api/chat`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: userMessage,
                            session_id: currentSession
                        })
                    });
                    
                    const data = await response.json();
                    setCurrentSession(data.session_id);
                    
                    // è¿æ¥WebSocketè·å–å®æ—¶è¿›åº¦
                    connectWebSocket(data.session_id);
                    
                    // æ·»åŠ åŠ©æ‰‹å“åº”
                    setMessages(prev => [...prev, {
                        type: 'assistant',
                        content: 'æ”¶åˆ°æ‚¨çš„è¯·æ±‚ï¼æ­£åœ¨ä¸ºæ‚¨ç”Ÿæˆè§†é¢‘ï¼Œè¿™ä¸ªè¿‡ç¨‹å¤§çº¦éœ€è¦2-3åˆ†é’Ÿ...',
                        timestamp: new Date()
                    }]);
                    
                    // è½®è¯¢çŠ¶æ€
                    const pollStatus = setInterval(async () => {
                        const statusResponse = await fetch(`${API_BASE_URL}/api/status/${data.session_id}`);
                        const statusData = await statusResponse.json();
                        
                        if (statusData.gpt_prompt && !gptPrompt) {
                            setGptPrompt(statusData.gpt_prompt);
                        }
                        
                        if (statusData.status === 'completed') {
                            clearInterval(pollStatus);
                            setVideoUrl(statusData.video_url);
                            setIsProcessing(false);
                            
                            setMessages(prev => [...prev, {
                                type: 'assistant',
                                content: `è§†é¢‘ç”Ÿæˆå®Œæˆï¼æ€»æ—¶é•¿40ç§’ï¼ŒåŒ…å«10ä¸ªè¿ç»­çš„4ç§’ç‰‡æ®µã€‚\n\næ ¸å¿ƒæ¦‚å¿µï¼š${statusData.gpt_prompt}`,
                                timestamp: new Date(),
                                hasVideo: true,
                                videoUrl: statusData.video_url
                            }]);
                            
                            // å…³é—­WebSocket
                            if (wsRef.current) {
                                wsRef.current.close();
                            }
                        } else if (statusData.status === 'error') {
                            clearInterval(pollStatus);
                            setIsProcessing(false);
                            
                            setMessages(prev => [...prev, {
                                type: 'assistant',
                                content: `ç”Ÿæˆå¤±è´¥ï¼š${statusData.error}`,
                                timestamp: new Date(),
                                isError: true
                            }]);
                            
                            if (wsRef.current) {
                                wsRef.current.close();
                            }
                        }
                    }, 1000);
                    
                } catch (error) {
                    console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                    setIsProcessing(false);
                    
                    setMessages(prev => [...prev, {
                        type: 'assistant',
                        content: 'æŠ±æ­‰ï¼Œå‘ç”Ÿäº†é”™è¯¯ã€‚è¯·ç¨åé‡è¯•ã€‚',
                        timestamp: new Date(),
                        isError: true
                    }]);
                }
            };
            
            // ä¸‹è½½è§†é¢‘
            const downloadVideo = () => {
                if (!currentSession) return;
                window.open(`${API_BASE_URL}/api/download/${currentSession}`, '_blank');
            };
            
            // è·å–å½“å‰æ­¥éª¤ç´¢å¼•
            const getCurrentStepIndex = () => {
                const stepText = workflowStatus.step.toLowerCase();
                if (stepText.includes('æç‚¼')) return 0;
                if (stepText.includes('åˆå§‹å›¾')) return 1;
                if (stepText.includes('è§†é¢‘ç‰‡æ®µ')) return 2;
                if (stepText.includes('éŸ³é¢‘')) return 3;
                if (stepText.includes('åˆæˆ') || stepText.includes('æœ€ç»ˆ')) return 4;
                return -1;
            };
            
            const currentStepIndex = getCurrentStepIndex();
            
            return (
                <div className="min-h-screen p-4 md:p-6">
                    <div className="max-w-6xl mx-auto">
                        {/* å¤´éƒ¨ */}
                        <header className="glass rounded-2xl p-6 mb-6 animate-fade-in">
                            <h1 className="text-3xl font-bold text-white mb-2">
                                ğŸ¬ ReasoningACTION AIè§†é¢‘ç”Ÿæˆç³»ç»Ÿ
                            </h1>
                            <p className="text-white/80">
                                é€šè¿‡è‡ªç„¶è¯­è¨€æè¿°ï¼ŒAIè‡ªåŠ¨ç”Ÿæˆ40ç§’çš„å®Œæ•´è§†é¢‘
                            </p>
                        </header>
                        
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            {/* å·¦ä¾§ - å¯¹è¯åŒºåŸŸ */}
                            <div className="lg:col-span-2">
                                <div className="bg-white rounded-xl shadow-xl animate-fade-in">
                                    {/* æ¶ˆæ¯åˆ—è¡¨ */}
                                    <div className="h-96 overflow-y-auto p-6 space-y-4">
                                        {messages.length === 0 ? (
                                            <div className="text-center text-gray-500 py-12">
                                                <div className="text-4xl mb-4">ğŸ’­</div>
                                                <p>æè¿°æ‚¨æƒ³è¦ç”Ÿæˆçš„è§†é¢‘åœºæ™¯</p>
                                                <p className="text-sm mt-2">ä¾‹å¦‚ï¼šç”Ÿæˆä¸€ä¸ªæ£®æ—åœºæ™¯çš„æµå¼è§†é¢‘</p>
                                            </div>
                                        ) : (
                                            messages.map((msg, index) => (
                                                <div
                                                    key={index}
                                                    className={`flex ${msg.type === 'user' ? 'justify-end' : 'justify-start'} animate-fade-in`}
                                                >
                                                    <div className={msg.type === 'user' ? 'message-user' : 'message-assistant'}>
                                                        <div className="whitespace-pre-wrap">{msg.content}</div>
                                                        {msg.hasVideo && msg.videoUrl && (
                                                            <div className="mt-4">
                                                                <video
                                                                    controls
                                                                    className="w-full rounded-lg"
                                                                    src={`${API_BASE_URL}${msg.videoUrl}`}
                                                                />
                                                                <button
                                                                    onClick={downloadVideo}
                                                                    className="btn-secondary mt-2 w-full"
                                                                >
                                                                    ğŸ“¥ ä¸‹è½½è§†é¢‘
                                                                </button>
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                        <div ref={messagesEndRef} />
                                    </div>
                                    
                                    {/* è¾“å…¥åŒºåŸŸ */}
                                    <div className="border-t p-4">
                                        <div className="flex gap-2">
                                            <input
                                                type="text"
                                                value={inputText}
                                                onChange={(e) => setInputText(e.target.value)}
                                                onKeyPress={(e) => e.key === 'Enter' && !e.shiftKey && sendMessage()}
                                                placeholder="æè¿°æ‚¨æƒ³è¦çš„è§†é¢‘..."
                                                disabled={isProcessing}
                                                className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                            />
                                            <button
                                                onClick={sendMessage}
                                                disabled={isProcessing || !inputText.trim()}
                                                className="btn-primary"
                                            >
                                                {isProcessing ? (
                                                    <span className="inline-block animate-spin">âš™ï¸</span>
                                                ) : (
                                                    'å‘é€'
                                                )}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                {/* GPT Promptæ˜¾ç¤º */}
                                {gptPrompt && (
                                    <div className="mt-6 glass rounded-xl p-4 animate-fade-in">
                                        <h3 className="text-white font-semibold mb-2">ğŸ¤– AIæç‚¼çš„æ ¸å¿ƒæ¦‚å¿µ</h3>
                                        <p className="text-white/90 text-sm">{gptPrompt}</p>
                                    </div>
                                )}
                            </div>
                            
                            {/* å³ä¾§ - å·¥ä½œæµçŠ¶æ€ */}
                            <div className="lg:col-span-1">
                                <div className="bg-white rounded-xl shadow-xl p-6 animate-fade-in">
                                    <h2 className="text-xl font-semibold mb-4">å·¥ä½œæµç¨‹</h2>
                                    
                                    {/* è¿›åº¦æ¡ */}
                                    {isProcessing && (
                                        <div className="mb-4">
                                            <div className="flex justify-between text-sm text-gray-600 mb-1">
                                                <span>{workflowStatus.step}</span>
                                                <span>{Math.round(workflowStatus.progress)}%</span>
                                            </div>
                                            <div className="progress-bar">
                                                <div 
                                                    className="progress-fill"
                                                    style={{ width: `${workflowStatus.progress}%` }}
                                                />
                                            </div>
                                        </div>
                                    )}
                                    
                                    {/* å·¥ä½œæµæ­¥éª¤ */}
                                    <div className="space-y-2">
                                        {WORKFLOW_STEPS.map((step, index) => (
                                            <div
                                                key={step.id}
                                                className={`workflow-step ${
                                                    index === currentStepIndex ? 'active' :
                                                    index < currentStepIndex ? 'completed' : ''
                                                }`}
                                            >
                                                <div className={`step-icon ${
                                                    index === currentStepIndex ? 'active' :
                                                    index < currentStepIndex ? 'completed' : 'pending'
                                                }`}>
                                                    {index < currentStepIndex ? 'âœ“' : step.icon}
                                                </div>
                                                <div className="flex-1">
                                                    <div className="font-medium text-gray-800">
                                                        {step.name}
                                                    </div>
                                                    {step.id === 'generate_video' && workflowStatus.currentVideoSegment > 0 && (
                                                        <div className="text-xs text-gray-500 mt-1">
                                                            ç‰‡æ®µ {workflowStatus.currentVideoSegment}/10
                                                        </div>
                                                    )}
                                                </div>
                                                {index === currentStepIndex && isProcessing && (
                                                    <div className="animate-pulse">
                                                        <div className="w-2 h-2 bg-purple-500 rounded-full"></div>
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                    
                                    {/* è¯´æ˜ */}
                                    <div className="mt-6 p-4 bg-gray-50 rounded-lg">
                                        <h3 className="font-semibold text-gray-700 mb-2">ç”Ÿæˆè§„æ ¼</h3>
                                        <ul className="text-sm text-gray-600 space-y-1">
                                            <li>â€¢ è§†é¢‘æ€»æ—¶é•¿ï¼š40ç§’</li>
                                            <li>â€¢ è§†é¢‘ç‰‡æ®µï¼š10ä¸ªÃ—4ç§’</li>
                                            <li>â€¢ éŸ³é¢‘æ—¶é•¿ï¼š10ç§’ï¼ˆå¾ªç¯4æ¬¡ï¼‰</li>
                                            <li>â€¢ åˆ†è¾¨ç‡ï¼š1024Ã—768</li>
                                        </ul>
                                    </div>
                                </div>
                                
                                {/* MCPæ¨¡å—è¯´æ˜ */}
                                <div className="mt-6 glass rounded-xl p-4 animate-fade-in">
                                    <h3 className="text-white font-semibold mb-3">MCPæ¨¡å—</h3>
                                    <div className="space-y-2 text-white/80 text-sm">
                                        <div className="flex items-center">
                                            <span className="w-16 font-mono">MCP1:</span>
                                            <span>æ–‡æœ¬â†’å›¾ç‰‡</span>
                                        </div>
                                        <div className="flex items-center">
                                            <span className="w-16 font-mono">MCP2:</span>
                                            <span>å›¾ç‰‡â†’è§†é¢‘(4s)</span>
                                        </div>
                                        <div className="flex items-center">
                                            <span className="w-16 font-mono">MCP3:</span>
                                            <span>å›¾ç‰‡â†’éŸ³é¢‘(10s)</span>
                                        </div>
                                        <div className="flex items-center">
                                            <span className="w-16 font-mono">MCP4:</span>
                                            <span>è§†é¢‘+éŸ³é¢‘åˆæˆ</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }
        
        // æ¸²æŸ“åº”ç”¨
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>